<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    
    <title>Acesso - Barbearia</title>

    <link rel="icon" href="../adds/logo.png" type="image/png">

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>

    <script src="../adds/apibase.js"></script>
    <script src="../adds/nome.app.js"></script>
    <script src="../adds/ART.js"></script>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#FFFFFF",
                        "background-light": "#f7f7f7",
                        "background-dark": "#121212", /* Fundo Escuro */
                        "text-primary": "#FFFFFF",
                        "text-secondary": "#A8A8A8",
                        "button-bg": "#FFFFFF",
                        "button-text": "#000000",
                        "input-bg": "rgba(255, 255, 255, 0.05)",
                        "input-border": "rgba(255, 255, 255, 0.2)",
                        "input-placeholder": "rgba(255, 255, 255, 0.4)",
                    },
                    fontFamily: { display: "Spline Sans" },
                    borderRadius: { DEFAULT: "0.5rem", lg: "1rem", xl: "1.5rem", full: "9999px" }
                }
            }
        };
    </script>

    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; font-size: 24px; }
        body { min-height: 100vh; }
        .hidden { display: none !important; }
        
        /* Animação suave entre telas */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Estilo padrão para inputs */
        .input-custom {
            width: 100%;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 9999px; /* Rounded full */
            height: 3.5rem; /* h-14 */
            padding-left: 1.5rem; padding-right: 1.5rem;
            color: white;
            outline: none;
            transition: all 0.2s;
        }
        .input-custom:focus {
            border-color: white;
            background-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 0 2px rgba(255,255,255,0.2);
        }
    </style>
</head>

<body class="bg-background-dark font-display text-text-primary overflow-x-hidden">

    <div class="relative flex h-auto min-h-screen w-full flex-col items-center justify-center p-6 group/design-root">
        <div class="w-full max-w-sm">

            <div class="flex justify-center mb-10">
                <img src="../adds/logo.png" alt="Logo" class="h-32 w-auto object-contain drop-shadow-2xl hover:scale-105 transition-transform duration-500" 
                     onerror="this.style.display='none'">
            </div>

            <div id="view-login" class="fade-in">
                <h1 class="text-text-primary tracking-tight text-5xl font-bold leading-tight text-center pb-10">Bem-vindo</h1>
                
                <form onsubmit="fazerLogin(event)" class="flex w-full flex-col gap-4">
                    <label class="flex flex-col w-full flex-1">
                        <p class="text-text-secondary text-base font-medium leading-normal pb-2">Email</p>
                        <input id="login-email" type="email" required placeholder="seu@email.com" class="input-custom">
                    </label>

                    <label class="flex flex-col w-full flex-1">
                        <p class="text-text-secondary text-base font-medium leading-normal pb-2">Senha</p>
                        <div class="relative flex w-full flex-1 items-center">
                            <input id="login-senha" type="password" required placeholder="Sua senha" class="input-custom pr-12">
                            <button type="button" onclick="togglePass('login-senha')" class="absolute right-0 p-4 text-input-placeholder hover:text-white">
                                <span class="material-symbols-outlined">visibility</span>
                            </button>
                        </div>
                    </label>

                    <div class="flex pt-6">
                        <button type="submit" id="btn-login" class="flex min-w-[84px] w-full cursor-pointer items-center justify-center overflow-hidden rounded-full h-14 px-5 bg-button-bg text-button-text text-base font-bold leading-normal hover:bg-opacity-90 transition-all active:scale-95">
                            <span class="truncate">ENTRAR</span>
                        </button>
                    </div>
                </form>

                <div class="w-full flex justify-center pt-6 pb-8">
                    <a onclick="trocarTela('view-recuperar')" class="text-text-secondary text-base font-medium hover:text-text-primary transition-colors cursor-pointer">
                        Esqueceu a senha?
                    </a>
                </div>
                <p class="text-text-secondary text-base font-normal text-center">
                    Não tem conta? <a onclick="trocarTela('view-cadastro')" class="font-bold text-text-primary hover:underline cursor-pointer">Crie uma agora</a>
                </p>
            </div>

            <div id="view-cadastro" class="hidden fade-in">
                <h1 class="text-text-primary text-4xl font-bold text-center pb-8">Criar Conta</h1>
                
                <form onsubmit="fazerCadastro(event)" class="flex w-full flex-col gap-4">
                    <input id="cad-nome" type="text" required placeholder="Nome Completo" class="input-custom">
                    <input id="cad-email" type="email" required placeholder="E-mail" class="input-custom">
                    
                    <div class="flex gap-2">
                        <input id="cad-telefone" type="tel" required placeholder="WhatsApp" class="input-custom w-1/2">
                        <input id="cad-cpf" type="text" required placeholder="CPF" class="input-custom w-1/2">
                    </div>

                    <div class="relative">
                        <input id="cad-senha" type="password" required placeholder="Crie uma Senha" class="input-custom pr-12">
                        <button type="button" onclick="togglePass('cad-senha')" class="absolute right-0 p-4 text-input-placeholder hover:text-white">
                            <span class="material-symbols-outlined">visibility</span>
                        </button>
                    </div>

                    <div class="flex pt-4">
                        <button type="submit" id="btn-cad" class="flex w-full cursor-pointer items-center justify-center rounded-full h-14 bg-button-bg text-button-text text-base font-bold hover:bg-opacity-90 transition-all active:scale-95">
                            CADASTRAR
                        </button>
                    </div>
                </form>

                <div class="w-full flex justify-center pt-6">
                    <a onclick="trocarTela('view-login')" class="text-text-secondary hover:text-text-primary cursor-pointer flex items-center gap-2">
                        <span class="material-symbols-outlined">arrow_back</span> Voltar para Login
                    </a>
                </div>
            </div>

            <div id="view-recuperar" class="hidden fade-in">
                <h1 class="text-text-primary text-3xl font-bold text-center pb-2">Recuperar Senha</h1>
                <p class="text-text-secondary text-center pb-8 text-sm">Enviaremos um código para seu WhatsApp cadastrado.</p>

                <div id="step-1" class="flex flex-col gap-4">
                    <input id="rec-cpf" type="text" placeholder="Digite seu CPF" class="input-custom">
                    <button onclick="pedirToken()" id="btn-token" class="w-full rounded-full h-14 bg-button-bg text-button-text font-bold hover:bg-opacity-90 transition-all active:scale-95">
                        ENVIAR CÓDIGO
                    </button>
                </div>

                <div id="step-2" class="hidden flex flex-col gap-4">
                    <input id="rec-token" type="text" placeholder="Código de 4 dígitos" class="input-custom text-center tracking-widest font-bold border-primary">
                    <input id="rec-novasenha" type="password" placeholder="Nova Senha" class="input-custom">
                    <button onclick="redefinirSenha()" id="btn-redefinir" class="w-full rounded-full h-14 bg-green-500 text-white font-bold hover:bg-green-600 transition-all active:scale-95">
                        SALVAR NOVA SENHA
                    </button>
                </div>

                <div class="w-full flex justify-center pt-6">
                    <a onclick="trocarTela('view-login')" class="text-text-secondary hover:text-text-primary cursor-pointer">Cancelar</a>
                </div>
            </div>

        </div>

        <div id="toast" class="fixed top-6 right-6 px-6 py-4 rounded-xl shadow-2xl transform translate-x-full transition-transform duration-300 z-50 flex items-center gap-3 border border-white/10 backdrop-blur-md">
            <span id="toast-icon" class="material-symbols-outlined">info</span>
            <span id="toast-msg" class="font-bold">Notificação</span>
        </div>

    </div>

    <script>
        // ---------------- UTILS ----------------
        function trocarTela(idTela) {
            ['view-login', 'view-cadastro', 'view-recuperar'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
                document.getElementById(id).classList.remove('fade-in');
            });
            const tela = document.getElementById(idTela);
            tela.classList.remove('hidden');
            // Hack para reiniciar animação
            void tela.offsetWidth; 
            tela.classList.add('fade-in');
        }

        function togglePass(id) {
            const el = document.getElementById(id);
            el.type = el.type === 'password' ? 'text' : 'password';
        }

        function showToast(msg, tipo = 'erro') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const text = document.getElementById('toast-msg');

            text.innerText = msg;
            
            if (tipo === 'sucesso') {
                toast.className = "fixed top-6 right-6 px-6 py-4 rounded-xl shadow-2xl transition-transform duration-300 z-50 flex items-center gap-3 border border-green-500/50 bg-green-900/80 text-white translate-x-0";
                icon.innerText = "check_circle";
            } else {
                toast.className = "fixed top-6 right-6 px-6 py-4 rounded-xl shadow-2xl transition-transform duration-300 z-50 flex items-center gap-3 border border-red-500/50 bg-red-900/80 text-white translate-x-0";
                icon.innerText = "error";
            }

            setTimeout(() => toast.classList.add('translate-x-full'), 3000);
        }

        // ---------------- 1. LOGIN ----------------
        async function fazerLogin(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-login');
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerText = "Validando...";

            try {
                const res = await fetch(getApiUrl('/auth/login'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email: document.getElementById('login-email').value,
                        senha: document.getElementById('login-senha').value,
                        tipo: 'cliente'
                    })
                });
                const data = await res.json();

                if(res.ok && !data.erro) {
                    showToast(`Bem-vindo, ${data.dados.nome}!`, 'sucesso');
                    localStorage.setItem('user', JSON.stringify(data.dados));
                    // Redireciona para Dashboard
                    setTimeout(() => window.location.href = 'dashboard.html', 1500);
                } else {
                    throw new Error(data.mensagem || 'Credenciais inválidas');
                }
            } catch (err) {
                showToast(err.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // ---------------- 2. CADASTRO ----------------
        async function fazerCadastro(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-cad');
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerText = "Criando...";

            try {
                const res = await fetch(getApiUrl('/clientes'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        nome: document.getElementById('cad-nome').value,
                        email: document.getElementById('cad-email').value,
                        telefone: document.getElementById('cad-telefone').value,
                        cpf: document.getElementById('cad-cpf').value,
                        senha: document.getElementById('cad-senha').value,
                        foto: null
                    })
                });
                const data = await res.json();

                if(res.ok && !data.erro) {
                    showToast('Conta criada com sucesso!', 'sucesso');
                    setTimeout(() => trocarTela('view-login'), 1500);
                } else {
                    throw new Error(data.mensagem || 'Erro ao criar conta');
                }
            } catch (err) {
                showToast(err.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // ---------------- 3. RECUPERAÇÃO ----------------
        let cpfTemp = '';

        async function pedirToken() {
            const btn = document.getElementById('btn-token');
            const cpf = document.getElementById('rec-cpf').value;
            cpfTemp = cpf;

            btn.disabled = true;
            btn.innerText = "Enviando...";

            try {
                const res = await fetch(getApiUrl('/auth/recuperar-senha'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ cpf, tipo_usuario: 'cliente' })
                });
                const data = await res.json();

                if(res.ok && !data.erro) {
                    showToast('Código enviado pro WhatsApp!', 'sucesso');
                    document.getElementById('step-1').classList.add('hidden');
                    document.getElementById('step-2').classList.remove('hidden');
                } else {
                    throw new Error(data.mensagem || 'CPF não encontrado');
                }
            } catch (err) {
                showToast(err.message);
                btn.disabled = false;
                btn.innerText = "ENVIAR CÓDIGO";
            }
        }

        async function redefinirSenha() {
            const btn = document.getElementById('btn-redefinir');
            const token = document.getElementById('rec-token').value;
            const nova_senha = document.getElementById('rec-novasenha').value;

            btn.disabled = true;
            btn.innerText = "Salvando...";

            try {
                const res = await fetch(getApiUrl('/auth/redefinir-senha'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ cpf: cpfTemp, tipo_usuario: 'cliente', token, nova_senha })
                });
                const data = await res.json();

                if(res.ok && !data.erro) {
                    showToast('Senha alterada! Faça login.', 'sucesso');
                    setTimeout(() => trocarTela('view-login'), 2000);
                } else {
                    throw new Error(data.mensagem || 'Código inválido');
                }
            } catch (err) {
                showToast(err.message);
                btn.disabled = false;
                btn.innerText = "SALVAR NOVA SENHA";
            }
        }
    </script>

</body>
</html>